<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syne+Mono&display=swap');

        body {
            font-family: 'Syne Mono', monospace;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-align: center;
            color: #2c3e50;
            margin: 80px 10px;
        }

        video {
            width: 40vw;
            height: 30vw;
            margin: 2rem;
            background: #2c3e50;
        }

        .videos {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    <title>WebRTC Demo</title>
</head>
<body>
    <h2>1. Start your Webcam</h2>
    <div class="videos">
        <span>
            <h3>Local Stream</h3>
            <video id="webcamVideo" autoplay playsinline></video>
        </span>
        <span>
            <h3>Remote Stream</h3>
            <video id="remoteVideo" autoplay playsinline></video>
        </span>
    </div>

    <button id="webcamButton">Start webcam</button>
    
    <h2>2. Create a new Call</h2>
    <button id="callButton" disabled>Create Call (offer)</button>

    <h2>3. Join a Call</h2>
    <p>Answer the call from a different browser window or device</p>
    <button id="answerButton" disabled>Answer</button>

    <h2>4. Hangup</h2>
    <button id="hangupButton" disabled>Hangup</button>

    <script>
        let ws;
        let reconnectInterval = 3000; // 3 seconds
        let reconnectAttempts = 0;

        function createWebSocket() {
            ws = new WebSocket('wss://home.adammihajlovic.ca/robot/signaling');
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                console.log('✅ WebSocket connection established');
                reconnectAttempts = 0;
            };

            ws.onmessage = async (event) => {
                console.log('📨 WebSocket message received: ', event);
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'hello':
                        console.log('Hello!!!', data);
                        ws.send(JSON.stringify({ type: 'hello' }));
                        break;
                    case 'session':
                        console.log('Session!!!', data);
                        ws.send(JSON.stringify({ type: 'session', status: 'OK' }));
                        break;
                    case 'offer':
                        console.log('Offer!!! ', data);
                        call.offer = data;
                        answerButton.disabled = false;
                        await answerStuff(pc);
                        break;
                    case 'answer':
                        console.log('Answer!!! ', data);
                        call.answer = data;
                        if (!pc.currentRemoteDescription) {
                            const answerDescription = new RTCSessionDescription(data);
                            await pc.setRemoteDescription(answerDescription);
                        }
                        break;
                    case 'candidate':
                        console.log('Candidate type!!! ', data);
                        const candidate = new RTCIceCandidate(data.data);
                        await pc.addIceCandidate(candidate);
                        break;
                    default:
                        if (data.candidate) {
                            console.log('Candidate normal!!! ', data);
                            const candidate = new RTCIceCandidate(data);
                            await pc.addIceCandidate(candidate);
                        } else {
                            console.log('🤷 What is this ??? ', data);
                        }
                }
            };

            ws.onclose = () => {
                console.warn('⚠️ WebSocket closed, attempting to reconnect...');
                attemptReconnect();
            };

            ws.onerror = (err) => {
                console.error('❌ WebSocket error:', err);
                ws.close(); // Let the reconnect logic handle this
            };
        }

        function attemptReconnect() {
            reconnectAttempts++;
            const timeout = Math.min(reconnectInterval * reconnectAttempts, 30000); // cap at 30s
            console.log(`🔁 Reconnecting in ${timeout / 1000}s...`);
            setTimeout(() => {
                console.log('🔌 Reconnecting now...');
                createWebSocket();
            }, timeout);
        }

        // Call it the first time to start connection
        createWebSocket();
    </script>
</body>
</html>